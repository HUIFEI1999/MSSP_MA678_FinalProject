---
title: "MA678 Final Report"
author: "Huifei Xu"
date: "12/4/2022"
output: 
  pdf_document: 
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
	message = FALSE,
	warning = FALSE)
```

# Abstract

This report aims to examine the relationship between car sales and the economic attributes and traits of cars of interest to consumers or which factors primarily influence consumers' car purchase choices. To achieve the purpose of this study, I designed and built a multi-level model based on different major automobile brands or specific models as categories, and with corresponding exploratory data analysis to figure out the factors that can have a significant impact on consumers' choice of car purchase.

# Introduction

## Background

The automobile, the only high-tech product in the world today with tens of thousands of parts, tens of millions of annual production, and hundreds of millions of ownership, has become one of the most important modes of human transportation since its birth in 1886. In 2007, there were 800 million cars or light trucks on the road, consuming 9.8 trillion liters of fuel annually. It can be considered that cars, which can carry several people at the same time depending on the specific model, are a good choice for family travel. The overall structure of different cars may be roughly the same, but the use and manufacturing details may vary significantly from one brand of car product to another or from one model to another under the same brand. For the general public, there are several factors that may be decisive in determining exactly which model they purchase, it may be fuel efficiency, car price, motor power, etc. The purpose of this report is to examine which factors are most influential when it comes to consumer choice in purchasing a car.

Throughout the ages, taking into account the interaction of various factors and the development of the times, the car brand is still the main factor affecting consumers' choice of car. A comprehensive consideration of all factors, whether from the vehicle's cost performance, price and market performance, the brand factor is an important reason for its impact on consumers to choose a car. As a result, this report will use either the manufacturer's brand of the car or a specific special model as the categorical level to conduct an in-depth analysis to investigate the the physical attributes or economic attributes of the model itself will have an impact on its sales for different car brands.

## Data Summary

The data set i fould on Kaggle is 'Car sales'(URL:<https://www.kaggle.com/datasets/gagandeep16/car-sales>), published by Kaggle User GAGANBHATIA. For confidentiality reasons, the exact year of provenance of the sales data is not included, but it does not affect our study of the relationship between factors and sales. A csv file was provided which includes 16 columns of variables with 157 rows of data. Amount the variables, 3 of them are categorical variables which refers to bands and models, and 13 numeric variables covers both physical and economic/energy attributes of the car. This report is only concerned with some of these relatively representative and important variables. In order to make the model concise, some of them will be removed in the data cleaning section and will not be shown in the summary table. The table of columns with brief explanation is listed below:

+--------------------+------------------------------------------------------------------------------------+
| Column Names       | Explanation                                                                        |
+====================+====================================================================================+
| Manufacturer       | Name of the car manufacturer                                                       |
+--------------------+------------------------------------------------------------------------------------+
| Model              | Name of the specific model of the car                                              |
+--------------------+------------------------------------------------------------------------------------+
| Sales_in_thousands | Sales of cars, in thousands                                                        |
+--------------------+------------------------------------------------------------------------------------+
| Vehicle_type       | Passenger-carrying properties of automobiles                                       |
+--------------------+------------------------------------------------------------------------------------+
| Price_in_thousands | The selling price of the car, in thousands                                         |
+--------------------+------------------------------------------------------------------------------------+
| Engine_size        | The total volume of the cylinders in the engine                                    |
+--------------------+------------------------------------------------------------------------------------+
| Horsepower         | The power an engine produces                                                       |
+--------------------+------------------------------------------------------------------------------------+
| Wheelbase          | The distance between the centres of the front and rear wheels                      |
+--------------------+------------------------------------------------------------------------------------+
| Width              | Vehicle width measurement                                                          |
+--------------------+------------------------------------------------------------------------------------+
| Length             | Vehicle Length measurement                                                         |
+--------------------+------------------------------------------------------------------------------------+
| Curb_weight        | The weight of the vehicle including a full tank of fuel and all standard equipment |
+--------------------+------------------------------------------------------------------------------------+
| Fuel_capacity      | The amount of fuel that a vehicles fuel tank can hold                              |
+--------------------+------------------------------------------------------------------------------------+
| Fuel_efficiency    | The distance a motor vehicle can travel on a single gallon of gas                  |
+--------------------+------------------------------------------------------------------------------------+

# Method

# Result

# Discussion

## Test

```{r}
remove.package("rlang")
```


```{r}
library(readr)
library(dplyr)
library(lme4)
library(Matrix)
library(ggplot2)
```

```{r}

car_raw <- read_csv("Car_sales.csv")

car = select(car_raw, -4, -15:-16)
car <- na.omit(car)

```

```{r}

# Convert categorical variables to factors

car$Manufacturer <- as.factor(car$Manufacturer)
car$Model <- as.factor(car$Model)
car$Vehicle_type <- as.factor(car$Vehicle_type)

car_numeric <- select(car, -4, -1:-2)
```

```{r}


fit1 <- lmer(Sales_in_thousands ~ Price_in_thousands +  + (1 | Manufacturer),data = car)
fit1

```















#p1

```{r}
ggplot(data = car) + 
  aes(x = Price_in_thousands, y = log(Sales_in_thousands)) + 
  geom_point(aes(color = Manufacturer), size = .6) + 
  geom_smooth(aes(color = Manufacturer), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(a) Salary vs Points", x = "log(average points)", y = "log(Salary)")
```


points_by_position1 <- ggplot(data = NBA_data) + 
  aes(x = log(Points + 1), y = log(Salary)) + 
  geom_point(aes(color = Position1), size = .6) + 
  geom_smooth(aes(color = Position1), method = "lm", se = FALSE, formula = 'y ~ x') + 
  labs(title = "(b) Salary vs Points", x = "log(average points)", y = "log(Salary)") 
grid.arrange(points_by_teams, points_by_position1, ncol = 2)




```{r}
corrplot2 <- function(data,
                      method = "pearson",
                      sig.level = 0.05,
                      order = "original",
                      diag = FALSE,
                      type = "upper",
                      tl.srt = 90,
                      number.font = 1,
                      number.cex = 1,
                      mar = c(0, 0, 0, 0)) {
  library(corrplot)
  data_incomplete <- data
  data <- data[complete.cases(data), ]
  mat <- cor(data, method = method)
  cor.mtest <- function(mat, method) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat <- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
      for (j in (i + 1):n) {
        tmp <- cor.test(mat[, i], mat[, j], method = method)
        p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
      }
    }
    colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
    p.mat
  }
  p.mat <- cor.mtest(data, method = method)
  col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
  corrplot(mat,
    method = "color", col = col(200), number.font = number.font,
    mar = mar, number.cex = number.cex,
    type = type, order = order,
    addCoef.col = "black", # add correlation coefficient
    tl.col = "black", tl.srt = tl.srt, # rotation of text labels
    # combine with significance level
    p.mat = p.mat, sig.level = sig.level, insig = "blank",
    # hide correlation coefficients on the diagonal
    diag = diag
  )
}

```

```{r}
corrplot2(
  data = car_numeric,
  method = "pearson",
  sig.level = 0.05,
  order = "original",
  diag = FALSE,
  type = "upper",
  tl.srt = 75
)
```


```{r}
colnames(car)
```



```{r}
library(GGally)

ggpairs(dat[, c("Sales_in_thousands", "Price_in_thousands", "Fuel_efficiency")])
```






```{r}
coef(fit1)
summary(fit1)

Anova(fit1)
```




```{r}
coef(fit1)$Manufacturer
```


```{r}
plot(fit1)
```
```{r}
prediction <- predict(fit1)
plot(x = Price_in_thousands,y = Sales_in_thousands, color = Manufacturer,prediction, group = Manufacturer,y = prediction,data = car)
```













































































